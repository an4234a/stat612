---
title: "project"
author: "Alan- Kevin"
date: "11/1/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
```


```{r include=FALSE}
##load df
crime <- read_csv(file = "Arrests 2017 Public.csv")
```


# 1. There is a association between defendant profile (age, race, ethnicity and/or sex, state address) and type of arrest category. 

- There was more offense by male than by female; most defendant age is between 20-30 (graph a)
- There was more offense by Black than white and Asian. (graph b)
- Between White, there was not much difference for hispanic and non hispanic (Graph c)
- Simple Assault, Release Violations/Fugitive and Traffic Violations were the most occuring offense, either for male and female. 
- It were also the most occuring offense for all races (table i and table ii)
- We create new crime category income motivated crime and non income motivated crime, there are no difference in distribution with overall crime. (Graph d)

Conclusion: 
1.From crime distribution, here is a association between defendant profile (age, race and sex) and number of crime.
2. No association between between defendant profile (age, race, ethnicity and/or sex) and type of arrest category. 


## Graph a
```{r echo=FALSE}
crime %>%
  filter(`Defendant Sex` != "UNK") %>%
  ggplot(aes(Age)) +
  geom_histogram() + 
  theme_bw() + 
  facet_wrap(~`Defendant Sex`) +
  xlab("Defendant Age") + ylab("number of arrest") + ggtitle("number of arrest by age and gender in 2017") 
```

## Graph b
```{r echo=FALSE}
crime %>%
  filter(`Defendant Race` != "UNK") %>%
  ggplot(aes(Age)) +
  geom_histogram() + 
  theme_bw() + 
  facet_wrap(~`Defendant Race`) +
  xlab("Defendance age") + ylab("number of arrest") + ggtitle("number of arrest by age and Race in 2017") 
```
## Graph c
```{r echo=FALSE}
crime %>%
  filter(`Defendant Race` == "WHITE") %>%
  ggplot(aes(Age)) +
  geom_histogram() + 
  theme_bw() + 
  facet_wrap(~`Defendant Ethnicity`) +
  xlab("Defendant Age") + ylab("number of arrest") + ggtitle("number of arrest by White ethnicity in 2017") 
```

##table i
```{r echo=FALSE}
crime_by_sex <- crime %>%
  filter(`Defendant Sex` != "UNK") %>%
  group_by(`Arrest Category`,`Defendant Sex`) %>%
  tally () %>%
  ungroup() %>%
  spread(key = `Defendant Sex`, value = n)


##table i.1 - top 3 female offense
crime_by_sex %>%
  select(1,2) %>%
  arrange(desc(FEMALE)) %>%
  slice(1:3)

##table i.2 - top 3 male offense
crime_by_sex %>%
  filter( `Arrest Category` != "Other Crimes") %>%
  select(1,3) %>%
  arrange(desc(MALE)) %>%
  slice(1:3)
```

##table ii
```{r echo=FALSE}
crime_by_race <- crime %>%
  filter(`Defendant Race` != "UNK") %>%
  group_by(`Arrest Category`,`Defendant Race`) %>%
  tally () %>%
  ungroup() %>%
  spread(key = `Defendant Race`, value = n)
crime_by_race


##table ii - top 3 asian offense
crime_by_race %>%
  select(1,2) %>%
  arrange(desc(ASIAN)) %>%
  slice(1:3)

##table ii - top 3 BLACK offense
crime_by_race %>%
  select(1,3) %>%
  arrange(desc(BLACK)) %>%
  slice(1:3)

##table ii - top 3 WHITE offense
crime_by_race %>%
  select(1,4) %>%
  arrange(desc(WHITE)) %>%
  slice(1:3)
```
## Graph D
income related crime
```{r echo=FALSE}
inc_related_category <- c("Burglary", "Fraud and Financial Crimes" , "Kidnapping","Prostitution", "Robbery", "Theft","Theft from Auto")
income_rel <- crime %>%
  filter(`Arrest Category` %in% inc_related_category)
non_income_rel <- anti_join(crime,income_rel, by = "Arrest Category")
```


```{r echo=FALSE}
income_rel %>%
  filter(`Defendant Race` != "UNK") %>%
  ggplot(aes(Age)) +
  geom_histogram() + 
  theme_bw() + 
  facet_wrap(~`Defendant Race`) +
  xlab("Defendance age") + ylab("number of arrest") + ggtitle("Income motivated crime in 2017") 

non_income_rel %>%
  filter(`Defendant Race` != "UNK") %>%
  ggplot(aes(Age)) +
  geom_histogram() + 
  theme_bw() + 
  facet_wrap(~`Defendant Race`) +
  xlab("Defendance age") + ylab("number of arrest") + ggtitle("Non income motivated crime in 2017") 
```


# 2. There are area which more offence and/or arrest than other. (*I think since PSA is defined area, we can make 2 and 3 as one hypotesis)

- Most offense occured in center and south part of DC (map a)
- there was no difference between offense location and arrest location (map b)
- PSA number 102, 507, 506, 603, and 602  were the PSA with the most number of offenses (table iii)
- Most offense occured in center and south PSA in DC. Notably, few crimes occured in north part of DC (map c)

Conclusion : 
Most offense occured in center and south part of DC.
- There are area which more offence and/or arrest than other.

```{r include=FALSE}
library(sf) #package to handling shape file
library(viridis) ##color pallete for fill
```


```{r include=FALSE}
map <- read_sf("Ward_from_2012.shp") #dc map by ward from dc open data
class(map) #check type file
```
## Map a
```{r echo=FALSE}
#map laying
plotmap <- ggplot(map) +
  geom_sf(aes()) +
  theme_bw()
crime2 <- na.omit(crime)
plotmap + 
  geom_point(data = crime2, aes(`Arrest Longitude`, `Arrest Latitude`), alpha = 0.03, colour= "red") + 
  ggtitle("Arrest in DC") ##arrest location as xy point 
```

## map b
```{r echo=FALSE}

plotmap + 
  geom_point(data = crime2, aes(`Offense Longitude`, `Offense Latitude`), alpha = 0.03, colour= "blue") +
  ggtitle("Offense in DC")  ## offense location as xy point
```


## table iii
```{r include=FALSE}
psa <- read_sf("Police_Service_Areas.shp") ## data from dc open data
````

```{r echo=FALSE}
psa_crime <- crime %>%
  group_by(`Offense PSA`) %>%
  tally() %>%
  arrange(desc(n)) %>%
  rename(PSA = "Offense PSA") ##count offense by PSA

psa_crime %>%
  slice(1:5) %>%
  rename(Top_5_offense_location = PSA)
````
## map c
```{r echo=FALSE}
psa <- left_join(psa,psa_crime)

plotmap2 <- ggplot(psa) +
  geom_sf(aes(fill = n)) +
  scale_fill_viridis("number of crime") +
  theme_bw()
plotmap2
```

# 3. There is an association between type of offense and location.
- by mapping most number of offense in each PSA, we know that Simple assault are the most offense occured in most of PSA location
- Narcotic related offense was "popular" in center part of DC, while traffic offense was "most popular" in south part of DC. 
- Prostitution was the most occured offense in PSA 307, which cover much of the area surrounding Logan Circle. <source><https://www.borderstan.com/2012/02/01/closer-look-at-psa-307s-new-boundaries-personnel/>
- Release Violation/Fugitive was was the most occured offense in PSA 102 and 108. Probably because there is a court in those area,
Most Release Violation/Fugitive occurs when people did not show at court.

Conclusion : There is an association between type of offense and location. Certain crime occured more frequently in some areas than in other areas.


## map d
```{r echo=FALSE}
df <- crime %>%
  group_by(`Offense PSA`,`Arrest Category`) %>%
  tally() %>%
  mutate(the_rank  = rank(-n, ties.method = "random")) %>%
  filter(the_rank == 1) %>%
  rename(PSA = `Offense PSA`)
crime_type <- left_join(psa,df, by = "PSA")

ggplot(crime_type) +
  geom_sf(aes(fill = `Arrest Category`)) +
  theme_bw()
```



Income related crime, with addition to ACS data
Hypothesis: 1. The type of housing within an area contributed to the location that crime occurs, suggesting that most crime occurs within the neighborhood the perpetrator lives (John Hipp, Young-An Kim, and Kevin Kane)
2. There is a relationship between number of crime and income.

- Only 34.7% ffense committed by defendant happen within their own PSA, where for income related crime, only 13.93% offense committed by defendant happen within their own PSA.(table iv)
- There is a negative relationship between median income in a ward (from ACS data) with the number of crime. The higher median income in a ward, the lower number of offense occured.

## table iv
```{r echo=FALSE}
crime %>%
  group_by(`Defendant PSA`,`Offense PSA`) %>%
  tally() %>%
  ungroup() %>%
  mutate(same_location = ifelse(`Defendant PSA`==`Offense PSA`,"Y","N")) %>%
  group_by(same_location) %>%
  summarise( sum = sum(n, na.rm= FALSE))  ## 34.7% offense committed by defendant happen within their own PSA
  
income_rel %>%
  group_by(`Defendant PSA`,`Offense PSA`) %>%
  tally() %>%
  ungroup() %>%
  mutate(same_location = ifelse(`Defendant PSA`==`Offense PSA`,"Y","N")) %>%
  group_by(same_location) %>%
  summarise( sum = sum(n, na.rm= FALSE)) 
## in income related crime, 13.93% offense committed by defendant happen within their own PSA
```

#graph e
```{r}
## if any code should be displayed in power point, we think this is the most challenging code since ACS data have only ward aggregate and crime data have no information about ward.
ACS <- read_csv("612 project/economic.csv")
ACS <- na.omit(ACS)
ACS <- ACS %>%
  gather(-desc, key = "key", value = "value") %>%
  separate(key, into = c("key","ward"), sep = "_") %>%
  mutate(ward = recode(ward,
                       `1` = "2",
                       `2` = "3",
                       `3` = "4",
                       `4` = "5",
                       `5` = "6",
                       `6` = "7",
                       `7` = "8", .missing = "1"))
ACS <- ACS %>%
  filter(str_detect(desc,"Median household income"),
         key == "Estimate") %>%
  mutate(value = str_replace_all(value,",",""),
         value = parse_number(value))
point <- as.data.frame(cbind(crime$`Offense Longitude`,crime$`Offense Latitude`))
point <-  na.omit(point)
point <- st_as_sf(point, coords = c("V1", "V2"))
st_crs(map)
point <- st_sf(point, crs = "+init=epsg:4326")

intersect <- st_intersection(x = map, y = point)
intersect <- intersect %>%
  group_by(NAME) %>%
  tally()
intersect <- intersect %>%
  separate(NAME, into= c("ward1", "ward"))
map <- map %>%
  separate(NAME, into= c("ward1", "ward"), sep = " ") %>%
  left_join(ACS, by = "ward") %>%
  st_join(intersect, by = "ward")
##south area in DC had lower median income

ggplot(map) + geom_sf(aes(fill = value)) 
crime_income_pw <- map %>%
  select(ward.x, value,n) %>%
  arrange(desc(value,n))
ggplot(crime_income_pw, aes(value,n)) + geom_point()+ geom_smooth(method= lm, se=FALSE)
##negative relatinship between median income and number of crime.
```

